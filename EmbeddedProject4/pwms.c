/*
 * pwm.c
 *
 *  Created on: 22 wrz 2014
 *      Author: TomB
 */

/*************************************************************************************************/

#include "pwms.h"


#include "timer3.h"

#include "general.h"
#include "stm32f10x.h"
#include "typedefs.h"

/*************************************************************************************************/
/*
 *
 * Wyj�� PWM nale�y szuka� w ustawieniach timera 3
 *
 *
 *  * Timer 3 remap options:
 * - no remap:
 * 		ch1 @A6	<-- used for STM32F103C8_BOARD
 * 		ch2 @A7	<-- used for STM32F103C8_BOARD
 * 		ch3 @B0	<-- used for STM32F103C8_BOARD
 * 		ch4 @B1	<-- used for STM32F103C8_BOARD
 * - partial remap:
 * 		ch1 @B4
 * 		ch2 @B5
 * 		ch3 @B0
 * 		ch4 @B10
 * 		ch4 @B1
 * - full remap:
 *  	ch1 @C6	<-- used for STM32F100RC_BOARD
 *  	ch2 @C7	<-- used for STM32F100RC_BOARD
 *  	ch3 @C8	<-- used for STM32F100RC_BOARD
 *  	ch4 @C9	<-- used for STM32F100RC_BOARD
 *
 */
/*************************************************************************************************/

#define PWM_DEBUG_ENABLE	1


#if (PWM_DEBUG_ENABLE==0)
	#define LedDebug(str,...)
#else
	#include "debug.h"
	#include "delay.h"
	#define PwmDebug(str,...) Debug(str,##__VA_ARGS__)
#endif

/*************************************************************************************************/

// 10-bit PWM to LED lookup table
const u16 PWM_FOR_EYE[101] = // from 0 to 100%
{
	// Ratio: unknown
//	0, 1, 2, 3, 4, 5, 7, 8, 10, 12, 15, 17, 20, 23, 26, 30, 33, 37, 41, 45, 50, 54,
//	59, 64, 69, 75, 80, 86, 92, 98, 105, 111, 118, 125, 133, 140, 148, 156, 164,
//	172, 180, 189, 198, 207, 216, 226, 236, 246, 256, 266, 277, 287, 298, 309, 321,
//	332, 344, 356, 368, 381, 393, 406, 419, 432, 446, 459, 473, 487, 501, 516, 530,
//	545, 560, 575, 591, 607, 622, 638, 655, 671, 688, 705, 722, 739, 757, 774, 792,
//	810, 829, 847, 866, 885, 904, 923, 943, 963, 982, 993, 1003, 1013, 1023
//
//	// Ratio: 1.0
//	0, 10, 20, 31, 41, 51, 61, 72, 82, 92, 102, 113, 123, 133, 143, 153, 164, 174,
//	184, 194, 205, 215, 225, 235, 246, 256, 266, 276, 286, 297, 307, 317, 327, 338,
//	348, 358, 368, 379, 389, 399, 409, 419, 430, 440, 450, 460, 471, 481, 491, 501,
//	512, 522, 532, 542, 552, 563, 573, 583, 593, 604, 614, 624, 634, 644, 655, 665,
//	675, 685, 696, 706, 716, 726, 737, 747, 757, 767, 777, 788, 798, 808, 818, 829,
//	839, 849, 859, 870, 880, 890, 900, 910, 921, 931, 941, 951, 962, 972, 982, 992,
//	1003, 1013, 1023

	// Ratio: 1.6
	0, 1, 2, 4, 6, 8, 11, 15, 18, 22, 26, 30, 34, 39, 44, 49, 55, 60, 66, 72, 78,
	84, 91, 97, 104, 111, 119, 126, 133, 141, 149, 157, 165, 174, 182, 191, 200,
	208, 218, 227, 236, 246, 255, 265, 275, 285, 295, 306, 316, 327, 337, 348, 359,
	370, 382, 393, 405, 416, 428, 440, 452, 464, 476, 488, 501, 513, 526, 539, 552,
	565, 578, 591, 605, 618, 632, 646, 659, 673, 687, 702, 716, 730, 745, 759, 774,
	789, 804, 819, 834, 849, 864, 880, 895, 911, 927, 942, 958, 974, 990, 1007, 1023
};

/*************************************************************************************************/

void Pwm_Init(void)
{
	Timer3_Init();
}

/*************************************************************************************************/

void Pwm1_Set(u16 value)
{
	if (IsPercent(value))
	{
		Timer3Channel1Duty(PWM_FOR_EYE[value]); // PinC6
	}
}

/*************************************************************************************************/

void Pwm2_Set(u16 value)
{
	if (IsPercent(value))
	{
		Timer3Channel2Duty(PWM_FOR_EYE[value]); // PinC7
	}
}

/*************************************************************************************************/

void Pwm3_Set(u16 value)
{
	if (IsPercent(value))
	{
		Timer3Channel3Duty(PWM_FOR_EYE[value]); // PinC8
	}
}

/*************************************************************************************************/

void Pwm4_Set(u16 value)
{
	if (IsPercent(value))
	{
		Timer3Channel4Duty(PWM_FOR_EYE[value]); // PinC9
	}
}

/*************************************************************************************************/

#if (PWM_DEBUG_ENABLE==1)

void Pwm_Test(void)
{
	Pwm_Init();

	u8 i=0;
	while (1)
	{
		Pwm1_Set(i);
		Pwm2_Set(i);
		Pwm3_Set(i);
		Pwm4_Set(i);
		i++;
		i%=100;
		DelayMs(10);
	}
}

#endif

/*************************************************************************************************/
